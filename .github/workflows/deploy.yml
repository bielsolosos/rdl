name: Deploy to VPS with Podman

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DEPLOY_TIMEOUT: 600

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: ðŸ” Verify SSH Connection
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
          VPS_PORT: ${{ secrets.VPS_PORT || '22' }}
        run: |
          echo "ðŸ”Œ Testando conexÃ£o SSH..."
          sshpass -p "$VPS_PASSWORD" ssh -o StrictHostKeyChecking=no -p $VPS_PORT $VPS_USER@$VPS_HOST "echo 'âœ… ConexÃ£o SSH estabelecida com sucesso!'"

      - name: ðŸš€ Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
          VPS_PROJECT_PATH: ${{ secrets.VPS_PROJECT_PATH }}
          VPS_PORT: ${{ secrets.VPS_PORT || '22' }}
        run: |
          sshpass -p "$VPS_PASSWORD" ssh -o StrictHostKeyChecking=no -p $VPS_PORT $VPS_USER@$VPS_HOST "
            set -e
            
            PROJECT_PATH='$VPS_PROJECT_PATH'
            
            echo '============================================'
            echo 'ðŸš€ Iniciando Deploy - \$(date +%Y-%m-%d\ %H:%M:%S)'
            echo '============================================'
            
            # Verificar se o diretÃ³rio existe
            if [ ! -d \"\$PROJECT_PATH\" ]; then
              echo 'âŒ Erro: DiretÃ³rio '\$PROJECT_PATH' nÃ£o encontrado!'
              echo 'ðŸ“ Crie o diretÃ³rio ou clone o repositÃ³rio primeiro:'
              echo '   mkdir -p \$(dirname \$PROJECT_PATH)'
              echo '   cd \$(dirname \$PROJECT_PATH)'
              echo '   git clone https://github.com/bielsolosos/Redirect-Lab.git'
              exit 1
            fi
            
            # Navegar para o diretÃ³rio do projeto
            cd \"\$PROJECT_PATH\"
            echo 'ðŸ“‚ DiretÃ³rio atual: '\$(pwd)
            
            # Verificar branch atual
            CURRENT_BRANCH=\$(git rev-parse --abbrev-ref HEAD)
            echo 'ðŸŒ¿ Branch atual: '\$CURRENT_BRANCH
            
            # Fazer backup da branch atual (caso precise reverter)
            BACKUP_COMMIT=\$(git rev-parse HEAD)
            echo 'ðŸ’¾ Backup do commit: '\$BACKUP_COMMIT
            
            echo ''
            echo 'ðŸ“¦ Atualizando cÃ³digo do repositÃ³rio...'
            git fetch origin main
            git pull origin main
            
            NEW_COMMIT=\$(git rev-parse HEAD)
            echo 'âœ… CÃ³digo atualizado para commit: '\$NEW_COMMIT
            
            echo ''
            echo 'ðŸ›‘ Parando containers...'
            podman compose down || echo 'âš ï¸ Nenhum container estava rodando'
            
            echo ''
            echo 'ðŸ”¨ Fazendo build das imagens...'
            podman compose build --no-cache
            
            echo ''
            echo 'âœ¨ Iniciando containers...'
            podman compose up -d
            
            # Aguardar containers iniciarem
            echo ''
            echo 'â³ Aguardando containers iniciarem...'
            sleep 5
            
            # Verificar se containers estÃ£o rodando
            echo ''
            echo 'ðŸ” Verificando status dos containers...'
            if podman compose ps | grep -q Up; then
              echo 'âœ… Containers iniciados com sucesso!'
            else
              echo 'âŒ Erro: Containers nÃ£o estÃ£o rodando!'
              echo 'ðŸ“‹ Logs dos containers:'
              podman compose logs --tail=50
              exit 1
            fi
            
            echo ''
            echo 'ðŸ§¹ Limpando imagens antigas...'
            podman image prune -f
            
            echo ''
            echo '============================================'
            echo 'âœ… Deploy concluÃ­do com sucesso!'
            echo '============================================'
            echo ''
            echo 'ðŸ“Š Status final dos containers:'
            podman compose ps
            echo ''
            echo 'ðŸ’» InformaÃ§Ãµes do sistema:'
            echo '   - Commit: '\$NEW_COMMIT
            echo '   - Data: '\$(date +%Y-%m-%d\ %H:%M:%S)
            echo '   - UsuÃ¡rio: '\$(whoami)
            echo '   - Hostname: '\$(hostname)
          "

      - name: ðŸ” Health Check
        if: success()
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
          VPS_PROJECT_PATH: ${{ secrets.VPS_PROJECT_PATH }}
          VPS_PORT: ${{ secrets.VPS_PORT || '22' }}
        run: |
          echo "ðŸ¥ Executando health check..."
          sshpass -p "$VPS_PASSWORD" ssh -o StrictHostKeyChecking=no -p $VPS_PORT $VPS_USER@$VPS_HOST "
            PROJECT_PATH='$VPS_PROJECT_PATH'
            cd \"\$PROJECT_PATH\"
            
            # Verificar se os containers estÃ£o saudÃ¡veis
            RUNNING_CONTAINERS=\$(podman compose ps --format json | jq -r '.[].State' | grep -c running || echo 0)
            echo 'ðŸ“Š Containers rodando: '\$RUNNING_CONTAINERS
            
            if [ \"\$RUNNING_CONTAINERS\" -eq 0 ]; then
              echo 'âŒ Nenhum container estÃ¡ rodando!'
              exit 1
            fi
            
            echo 'âœ… Health check passou!'
          "

      - name: ðŸ“ Deployment Summary
        if: always()
        run: |
          echo "## ðŸ“‹ Resumo do Deploy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Autor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Data**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
